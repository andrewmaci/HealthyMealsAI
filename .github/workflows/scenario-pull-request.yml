name: Scenario Pull Request

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: scenario-pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node and install dependencies
        uses: ./.github/actions/setup-node-install

      - name: Run ESLint
        run: npm run lint

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      coverage: ${{ steps.coverage-summary.outputs.summary }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node and install dependencies
        uses: ./.github/actions/setup-node-install

      - name: Run Vitest with coverage
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_DEFAULT_MODEL: ${{ vars.OPENROUTER_DEFAULT_MODEL }}
          E2E_USERNAME_ID: ${{ secrets.E2E_USERNAME_ID }}
          E2E_USERNAME: ${{ secrets.E2E_USERNAME }}
          E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
        run: npm run test:unit:coverage -- --coverage.dir=coverage/unit --coverage.reporter=text-summary --coverage.reporter=lcov

      - name: Collect unit coverage summary
        id: coverage-summary
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const path = 'coverage/unit/coverage-summary.json';
          if (!fs.existsSync(path)) {
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'summary=Unit coverage summary not found\n');
            process.exit(0);
          }
          const summary = JSON.parse(fs.readFileSync(path, 'utf8'));
          const metrics = ['lines', 'statements', 'branches', 'functions'];
          const format = (metric) => {
            const data = summary.total[metric] || {};
            if (!('pct' in data)) {
              return `${metric}: n/a`;
            }
            return `${metric.charAt(0).toUpperCase() + metric.slice(1)} ${data.pct.toFixed(2)}% (${data.covered}/${data.total})`;
          };
          const message = metrics.map(format).join(', ');
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `summary=${message}\n`);
          NODE

      - name: Upload unit coverage artifacts
        uses: actions/upload-artifact@v5
        with:
          name: unit-coverage
          path: coverage/unit
          if-no-files-found: error

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      coverage: ${{ steps.coverage-summary.outputs.summary }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node and install dependencies
        uses: ./.github/actions/setup-node-install

      - name: Install Playwright browsers
        shell: bash
        run: npx playwright install --with-deps chromium

      - name: Provision test environment variables
        shell: bash
        run: |
          if [ -f .env.test ]; then
            echo ".env.test already exists"
          elif [ -f .env.example ]; then
            cp .env.example .env.test
            echo "Created .env.test from .env.example"
          else
            echo "No .env.example found, skipping .env.test provisioning"
          fi

      - name: Run Playwright end-to-end tests with coverage
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_DEFAULT_MODEL: ${{ vars.OPENROUTER_DEFAULT_MODEL }}
          E2E_USERNAME_ID: ${{ secrets.E2E_USERNAME_ID }}
          E2E_USERNAME: ${{ secrets.E2E_USERNAME }}
          E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
          PLAYWRIGHT_JAVASCRIPT_COVERAGE: "1"
        run: npx playwright test --coverage --reporter=line

      - name: Collect e2e coverage summary
        id: coverage-summary
        shell: bash
        run: |
          mkdir -p coverage/e2e
          if [ ! -d .playwright-coverage ]; then
            echo "summary=E2E coverage data not found" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          npx playwright show-coverage --reporter=lcov --output=coverage/e2e/lcov.info
          npx playwright show-coverage --reporter=html --output=coverage/e2e/html
          coverage_text=$(npx playwright show-coverage --reporter=text)
          {
            echo "summary<<'EOF'"
            echo "$coverage_text"
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Upload e2e coverage artifacts
        uses: actions/upload-artifact@v5
        with:
          name: e2e-coverage
          path: coverage/e2e
          if-no-files-found: error

  status-comment:
    name: Status Comment
    runs-on: ubuntu-latest
    needs:
      - lint
      - unit-tests
      - e2e-tests
    if: ${{ needs.lint.result == 'success' && needs['unit-tests'].result == 'success' && needs['e2e-tests'].result == 'success' }}
    steps:
      - name: Publish pull request status comment
        uses: actions/github-script@v8
        env:
          UNIT_COVERAGE: ${{ needs['unit-tests'].outputs.coverage }}
          E2E_COVERAGE: ${{ needs['e2e-tests'].outputs.coverage }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const unitCoverage = process.env.UNIT_COVERAGE || 'Unit coverage summary unavailable.';
            const e2eCoverage = process.env.E2E_COVERAGE || 'E2E coverage summary unavailable.';
            const body = [
              '### âœ… Scenario pull request checks passed',
              '',
              '- Lint: success',
              `- Unit tests: success (${unitCoverage})`,
              `- E2E tests: success (${e2eCoverage})`,
              '',
              'Artifacts with coverage details:',
              '- `unit-coverage`',
              '- `e2e-coverage`'
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

